<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/custom.css">
  <link rel="stylesheet" href="css/feather.css">
  <link rel="stylesheet" id="darkTheme" href="css/dark.css">
  <link rel="stylesheet" id="lightTheme" href="css/light.css" disabled>
  <script src="js/sweetalert2.all.min.js"></script>
  <link id="darkThemeSweetAlert" rel="stylesheet" href="css/sweetalert/dark.css">
  <link id="defaultThemeSweetAlert" rel="stylesheet" href="css/sweetalert/sweetalert2.min.css" disabled>
  <link rel="icon" href="img/logo.jpg">
  <title>Perfil</title>
</head>

<body>

  <nav class="sticky-top navbar">
    <div class="nav-item flex-grow-1 m-0" style="margin-right: 0 !important;">
      <a id="logoRubio" href="pasajero/indexPasajero.html" class="navbar-brand" style="float: left;
      position: absolute;
      left: 0;
      top: 7px;">
        <img src="img/logo.jpg" class="img-logo" alt="rubio Logo">
      </a>
    </div>
    <div class="nav-item">
      <a class="nav-link my-2" href="#" id="modeSwitcher" data-mode="dark">
        <i class="fe fe-sun fe-16"></i>
      </a>
    </div>

    <!-- <div class="nav-item nav-notif">
      <a class="nav-link my-2" href="#" data-toggle="modal" data-target=".modal-notif">
        <span class="fe fe-bell fe-16"></span>
        <span class="dot dot-md bg-success"></span>
      </a>
    </div> -->

    <div class="nav-item dropdown">
      <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown"
        aria-haspopup="true" aria-expanded="false">
        <span class="avatar avatar-sm mt-2">
          <img id="imagenPerfil" src="img/avatar_default.jpg" alt="..." class="avatar-img rounded-circle">
        </span>
      </a>
      <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
        <a class="dropdown-item py-2 text-center" href="#">Perfil</a>
        <a class="dropdown-item py-2 text-center bg-danger desconectar"
          style="border-bottom-left-radius: 0.375rem; border-bottom-right-radius: 0.375rem; cursor: pointer">Desconectar</a>
      </div>
    </div>
  </nav>
  <!-- fin del navbar -->
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10 col-xl-8">
        <h2 class="mt-2">Perfil</h2>
        <div class="my-4">
          <form class="needs-validation" novalidate>
            <div class="row mt-3 align-items-center">
              <div class="col-md-3 text-center mb-5">
                <div class="avatar avatar-xl">
                  <label for="imgUsuario" style="cursor: pointer;">
                    <img src="/img/avatar_default.jpg" alt="..." class="avatar-img rounded-circle" id="imgUser">
                  </label>
                  <input type="file" id="imgUsuario" style="display: none;" accept="image/png, image/jpeg">
                </div>
              </div>
              <div class="col">
                <div class="row align-items-center">
                  <div class="col-md-7">
                    <h4 class="mb-1" id="nombreCompleto"></h4>
                    <p class="small mb-2" id="empresa"></p>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-4">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="modDNI">DNI</label>
                <input type="text" id="modDNI" class="form-control" placeholder="DNI" required>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group col-md-6">
                <label for="modNombre">Nombre</label>
                <input type="text" id="modNombre" class="form-control" placeholder="Nombre" required>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group col-md-6">
                <label for="modApellido">Apellido</label>
                <input type="text" id="modApellido" class="form-control" placeholder="Apellidos" required>
                <div class="invalid-feedback"></div>
              </div>
            </div>
            <div class="form-group col-md-6">
              <label for="modEmail">Email</label>
              <input type="email" class="form-control" id="modEmail" placeholder="email@ejemplo.come" required>
              <div class="invalid-feedback"></div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="modTelefono">Telefono</label>
                <input type="number" class="form-control" id="modTelefono" min="100000000" placeholder="975214556"
                  required>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group col-md-6">
                <label for="modUbicacion">Ubicacion de Salida</label>
                <select id="modUbicacion" class="form-control" required>
                  <option selected="true" value="">Seleccione una ubicación</option>
                </select>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group col-md-6">
                <label for="modTicket">Tipo de ticket</label>
                <input type="text" class="form-control" id="modTicket" placeholder="Diario" disabled>
              </div>
              <div class="form-group col-md-6">
                <label for="modEmpresa">Empresa</label>
                <select id="modEmpresa" class="form-control" required>
                  <option selected="true" value="">Seleccione una empresa</option>
                </select>
                <div class="invalid-feedback"></div>
              </div>
            </div>
            <hr class="my-4">
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="oldPass">Antigua Contraseña</label>
                  <input type="password" class="form-control" id="oldPass">
                  <div class="invalid-feedback">La contraseña no coincide</div>
                </div>
                <div class="form-group">
                  <label for="newPass">Nueva Contraseña</label>
                  <input type="password" class="form-control" id="newPass" minlength="8">
                  <div class="invalid-feedback" id="invalidFeedbackNewPass">La contraseña debe tener al menos 8
                    caracteres</div>
                </div>
                <div class="form-group">
                  <label for="confirmNewPass">Confirmar contraseña</label>
                  <input type="password" class="form-control" id="confirmNewPass">
                  <div class="invalid-feedback">Las contraseñas deben coincidir</div>
                </div>
              </div>
              <div class="col-md-6">
                <p class="mb-2">Requisitos de contraseña</p>
                <p class="small mb-2"> Para crear una nueva contraseña, debes cumplir con todos los siguientes
                  requisitos: </p>
                <ul class="small pl-4 mb-0">
                  <li> Mínimo 8 caracteres </li>
                  <li>Al menos un carácter especial</li>
                  <li>Al menos un número</li>
                </ul>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
          </form>
        </div> <!-- /.card-body -->
      </div> <!-- /.col-12 -->
    </div> <!-- .row -->
  </div>

  <div
    class="loadingOverlay d-none position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
    <div class="spinner-border" style="width: 3rem; height: 3rem" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  <script src="js/jquery-3.7.1.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="js/bdConnection.js"></script>
  <script src="js/bdUsuarios.js"></script>
  <script src="js/bdEmpresas.js"></script>
  <script src="js/bdUbicaciones.js"></script>
  <script src="js/usuario.js"></script>
  <script src="js/ubicacion.js"></script>
  <script src="js/empresa.js"></script>
  <script>


    let nombreCompleto;
    let empresa;
    let dni;
    let nombre;
    let apellido;
    let email;
    let telefono;
    let ticket;
    let ubicacionSelect;
    let empresaSelect;
    let oldPass;
    let newPass;
    let confirmNewPass;
    let usuario;
    let imgUser;
    let imgUsuario;

    document.addEventListener("DOMContentLoaded", function () {
      "use strict";
      verificacionPermisos(["2", "3"]);
      cargarFotoPerfil();

      nombreCompleto = document.getElementById("nombreCompleto");
      empresa = document.getElementById("empresa");
      dni = document.getElementById("modDNI");
      nombre = document.getElementById("modNombre");
      apellido = document.getElementById("modApellido");
      email = document.getElementById("modEmail");
      telefono = document.getElementById("modTelefono");
      ticket = document.getElementById("modTicket");
      ubicacionSelect = document.getElementById("modUbicacion");
      empresaSelect = document.getElementById("modEmpresa");
      oldPass = document.getElementById("oldPass");
      newPass = document.getElementById("newPass");
      confirmNewPass = document.getElementById("confirmNewPass");
      imgUsuario = document.getElementById("imgUsuario");
      imgUser = document.getElementById("imgUser");

      /**
       * Inicializa la pagina de perfil.
       * 
       * Muestra el spinner, carga las empresas y ubicaciones, y luego carga el perfil del usuario
       * actual en la base de datos.
       * 
       * @returns {Promise<void>}
       */
      async function init() {
        Spinner.show();
        getEmpresas(generarEmpresas);
        getUbicaciones(generarUbicaciones);
        setTimeout(async () => {
          await getUsuarioById(getCookie("usuario"), successLoadPerfil);
          await getImageUser(getCookie("usuario"), cargarFotoPerfil, true);
        }, 1000);
        let logorubio = document.getElementById("logoRubio");
        let redireccion = getCookie("tipo") != "3" ? "/pasajero/indexPasajero.html" : "/conductor/indexConductor.html";
        logorubio.href = redireccion;
      }
      init();

      //aqui comprobamos que la nueva contraseña no este vacia y que solo se requieran los campos
      //cuando se quiera introducir una nueva contraseña, tambien se comprueba que la nueva contraseña
      //sea igual que la confirmacion
      newPass.addEventListener('input', function () {
        if ($(this).val().trim() !== '') {
          $('input[type="password"]').attr('required', true);
        } else {
          $('input[type="password"]').attr('required', false);
        }

        confirmPasswordCheck();
      });

      //aqui comprobamos que la antigua contraseña realmente sea la misma que 
      // la que tenemos en el servidor
      oldPass.addEventListener('input', function () {
        if (oldPass.value === usuario.password || newPass.value == "") {
          oldPass.setCustomValidity(''); // Válido
        } else {
          oldPass.setCustomValidity('La contraseña no coincide'); // Inválido
        }
      });

      //aqui comprobamos que la nueva contraseña y la confirmacion sean iguales
      confirmNewPass.addEventListener('input', function () {
        confirmPasswordCheck();
      });

      imgUsuario.addEventListener('change', (event) => {
        const file = event.target.files[0];

        if (file) {
          const reader = new FileReader();

          reader.onload = function (event) {
            const base64Image = event.target.result; // Imagen en Base64 con prefijo
            imgUser.src = base64Image;
            usuario.img = base64Image;
          };

          reader.readAsDataURL(file);
        }
      });

      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(function (form) {
        form.addEventListener('submit', async function (event) {
          event.preventDefault(); // Siempre prevenir el envío predeterminado
          event.stopPropagation();

          if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return; // Si no es válido, no hacemos nada más
          }

          // Llamada al servidor
          try {
            Spinner.show();
            let empresaLocal;
            let ubicacionLocal;
            if (usuario.permisos == 3) {
              empresaLocal = 0;
              ubicacionLocal = 0;
            } else {
              empresaLocal = empresaSelect.value;
              ubicacionLocal = ubicacionSelect.value;
            }
            var usuarioEditado = new Usuario(
              usuario.id, dni.value, nombre.value, apellido.value, null, telefono.value,
              email.value, empresaLocal, true, usuario.permisos,
              usuario.tipoTicket, ubicacionLocal, usuario.token
            )
            usuarioEditado.img = usuario.img;
            if (!newPass.hasAttribute("required")) {
              await usuarioUpdate(usuarioEditado);
            } else {
              usuarioEditado.password = newPass.value;
              await usuarioUpdate(usuarioEditado);
            }
          } catch (error) {
            console.error("Error en la validación del servidor:", error);
            SweetAlert.alert("Ocurrió un error. Intenta nuevamente.");
          }

        }, false);
      });

      Desconectar.logout();
    });

    $("#modeSwitcher").on("click", function (e) {
      e.preventDefault(), modeSwitch(), location.reload()
    })


    /**
     * Actualiza los valores de los elementos de la pantalla de perfil
     * con los datos del usuario pasado como parametro
     * @param {Object} usuario El objeto usuario con los datos a mostrar
     */
    async function successLoadPerfil(usu) {
      try {
        usuario = usu;
        // console.log(usuario);
        nombreCompleto.innerHTML = usuario.nombre + ", " + usuario.apellidos;
        empresa.innerHTML = usuario.empresa.nombreComercial;
        dni.value = usuario.dni;
        nombre.value = usuario.nombre;
        apellido.value = usuario.apellidos;
        email.value = usuario.email;
        telefono.value = usuario.telefono;
        ticket.value = (usuario.tipoTicket != null && (usuario.tipoTicket == "77" || usuario.tipoTicket == "68") ? (usuario.tipoTicket == "77" ? "Mensual" : "Diario") : "Valor no registrado");
        empresaSelect.value = usuario.empresa.id;
        ubicacionSelect.value = usuario.ubicacion;
        if (usuario.permisos == 3) {
          empresaSelect.required = false;
          ubicacionSelect.required = false;
          empresaSelect.disabled = true;
          ubicacionSelect.disabled = true;
        }
        Spinner.hide();
      } catch (error) {
        console.error("algo anda mal :\n" + error);
        Spinner.hide();
      }
    }


    /**
     * Funcion que se encarga de procesar la respuesta del servidor
     * cuando se intenta actualizar el perfil del usuario
     * @param {Object} data La respuesta del servidor
     */
    async function successUpdate(data) {
      try {
        if (data == 1) {
          SweetAlert.successfull("Actualizado correctamente", null , location.reload.bind(location));
        } else {
          SweetAlert.alert("Algo anda mal", "Oops...", location.reload.bind(location));
        }
        localStorage.removeItem("imagenPerfil");
        Spinner.hide();
      } catch (error) {
        console.error("algo anda mal :\n" + error);
        Spinner.hide();
      }
    }



    /**
     * Comprueba si la confirmacion de la nueva contrasena coincide
     * con la nueva contrasena. Si coincide o si la nueva contrasena esta
     * vacia, se considera como valido.
     * @returns {void}
     */
    function confirmPasswordCheck() {

      if (confirmNewPass.value === newPass.value || newPass.value == "") {
        confirmNewPass.setCustomValidity(''); // Válido
      } else {
        confirmNewPass.setCustomValidity('Las contrasenas no coinciden'); // Inválido
      }
    }
  </script>
</body>

</html>